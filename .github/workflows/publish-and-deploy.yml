name: Compile, publish, and deploy

on:
  release:
    types: [published]

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Install dependencies
        run: yarn

      - name: Compile Typescript
        run: yarn build

      - name: Run tests
        run: yarn test

      - name: Setup .yarnrc.yml
        run: |
          yarn config set npmAlwaysAuth true
          yarn config set npmAuthToken $NPM_AUTH_TOKEN
        env:
          NPM_AUTH_TOKEN: ${{ secrets.NPM_PUBLISH_TOKEN }}

      - name: Publish to NPM Registry
        run: |
          pkg_version=$(cat package.json | jq -r '.version')
          branch=${GITHUB_REF##*/}
          yarn version "$pkg_version"
          if [[ ! $pkg_version =~ [0-9]+\.[0-9]+\.[0-9]+ ]]; then
            yarn npm publish --tag beta
          else
            yarn npm publish
          fi
          echo "Published ref \`$branch\` as version $pkg_version to NPM registry"

      - name: Redeploy the extension server
        run: |
          set -e
            CURRENT_VERSION=$(jq -r '.version' < package.json)
            EXTENSION_NAME=$(jq -r '.name' < package.json)
            RESPONSE=$(curl -L -s -o /dev/null -w "%{http_code}" \
              -X POST \
              -H "Accept: application/vnd.github+json" \
              -H "Authorization: Bearer ${{ secrets.CONTENTS_AND_WORKFLOWS_TOKEN }}" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              https://api.github.com/repos/awell-health/awell-extension-server/actions/workflows/update-dependency.yml/dispatches \
              -d "{\"ref\":\"main\",\"inputs\":{\"dependency\":\"${EXTENSION_NAME}\",\"version\":\"${CURRENT_VERSION}\"}}")
            
            if [ "$RESPONSE" -ne 204 ]; then
              echo "Failed with response code $RESPONSE"
              exit 1
            else
              echo "Request succeeded with response code $RESPONSE"
            fi
